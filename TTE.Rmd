---
title: "MAP Prior with Time-to-Event Endpoint"
author: "Hongtao Zhang"
date: "9/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE) 
```

## The Data

The time-to-event (TTE) data from Roychoudhury and Neuenschwander (2020). 

The historical data were extracted from published Kaplan-Meier curves in 10 historical trials. The four year follow-up period was partitioned into 12 mutually exclusive intervals for the piecewise exponential model. 

```{r}
Time <- c("0.00-0.25", "0.25-0.50", "0.50-0.75", "0.75-1.00",
          "1.00-1.25", "1.25-1.50", "1.50-1.75", "1.75-2.08",
          "2.08-2.50", "2.50-2.92", "2.92-3.33", "3.33-4.00")
FIOCCO.n.events <- c(1,  3,  3,  4,  3,  0,  0,  2,  0,  6,  0,  0,  9,  1,  0, 10,  6,  6,  5,  9,
                     9,  3,  0,  0,  1,  3,  5,  7,  9,  4,  5, 10,  0,  0,  3,  7,  1,  2,  2,  4, 
                     3,  1,  3,  0,  0,  0,  0,  0,  5,  3,  6,  2,  3,  3,  0,  2,  1,  1,  1,  0, 
                     0,  6,  3, 12,  8,  2, 3,  2, 11,  1,  0, 10,  2,  2,  5,  3,  3,  3,  2,  3, 
                     3,  0,  0,  0,  0,  1,  3,  4, 1,  1,  4,  1,  6,  0,  0,  0,  2,  0,  3,  1, 
                     4,  0,  1,  1,  0,  0,  0,  0,  1,  5, 17, 0,  2,  7,  8,  4,  0,  6,  2,  0)
FIOCCO.exp.time <- c(9.4,  8.8,  7.9,  7.0,  6.1,  5.8,  5.8,  7.3,  8.8,  7.6,  6.2, 10.0, 21.1, 
                     19.9, 19.8, 18.5, 16.5, 15.0, 13.6, 15.7, 16.2, 13.6, 12.5, 20.1, 21.9, 21.4, 
                     20.4, 18.9, 16.9, 15.2, 14.1, 16.2, 18.5, 18.3, 17.0, 24.5,  5.6,  5.2,  4.8, 
                     4.0,  3.1,  2.6,  2.1,  2.3,  2.9,   2.9,  2.9,  4.7,  6.4,  5.4,  4.2,  3.2, 
                     2.6,  1.9,  1.5,  1.7, 1.5,  1.0,  0.6,  0.7, 17.8, 17.0, 15.9, 14.0, 11.5, 
                     10.2,  9.6, 11.9, 12.4,  9.9,  9.4, 12.1,  8.0,  7.5,  6.6,  5.6,  4.9,  4.1, 
                     3.5,  3.8,  3.6,  2.9,  2.9,  4.7,  9.2,  9.1,  8.6,  7.8,  7.1,  6.9,  6.2,  
                     7.4,  8.0,  6.7,  6.6, 10.7,  5.2,  5.0,  4.6,  4.1,  3.5,  3.0,  2.9,  3.5, 
                     4.2,  4.2,  4.1,  6.7, 23.4, 22.6, 19.9, 17.8, 17.5, 16.4, 14.5, 17.2, 21.0, 
                     19.7, 17.4, 27.5)
```

Reorganize the data in matrix form: 
```{r}
library(tidyverse)
library(knitr)
library(kableExtra)

rmat <- as_tibble(matrix(FIOCCO.n.events, nrow = 12, ncol = 10, byrow = F), .name_repair = "minimal")
colnames(rmat) <- c(paste("Hist",1:9, sep=""), "Curr")
rdt <- tibble(Interval=Time, rmat)
rdt %>% kbl(caption="Number of Events") %>% kable_classic(full_width = F, html_font = "Cambria")

Emat <- as_tibble(matrix(FIOCCO.exp.time, nrow = 12, ncol = 10, byrow = F), .name_repair = "minimal")
colnames(Emat) <- c(paste("Hist",1:9, sep=""), "Curr")
Edt <- tibble(Interval=Time, Emat)
Edt %>% kbl(caption="Total Exposure (in Years)") %>% kable_classic(full_width = F, html_font = "Cambria")
```

## Original MAP Prior
We use the data from the [0.00, 0.25) interval for illustration purpose. 

The number of events r is modeled as a Poisson random variable. The original MAP prior assumes a common normal distribution of log-hazards $\log(\lambda_{ij})$. Subscript $i=1,\cdots,12$ indices the time intervals, while subscript $j=1,\cdots,9$ historical trials: 
$$
\log(\lambda_{11}), \cdots, \log(\lambda_{19}) \sim N(\mu_1, \sigma^2_1), 
$$
where the hyper-priors are
$$
\mu_1 \sim N(0, 10^2) \mbox{ and } \sigma_1 \sim HN(0, 0.5).
$$
The hyper-prior of $\mu_1$ is vague is data would be sufficiently informative for it. The half-normal prior regulates the extent of borrowing and thus should be chosen carefully. One way is to examine its density plot. 
```{r, echo = FALSE}
library(extraDistr)
tt <- seq(0, 3, 0.05)
plotdt <- tibble(x = tt, density = dhnorm(tt, sigma = 0.5))

plotdt %>% 
  ggplot(aes(x, density)) + geom_line(size=1.5) + theme_bw() + ggtitle("Density Plot of Half-Normal Prior")
```

To properly handle the exposure, the important trick is to **use log-exposure as the *offset*** in *gMAP*. 
```{r}
rmat <- matrix(FIOCCO.n.events, nrow = 12, ncol = 10, byrow = F)
Emat <- matrix(FIOCCO.exp.time, nrow = 12, ncol = 10, byrow = F)

set.seed(1027)
library(RBesT)
histdt <- tibble(study = 1:9, r = rmat[1, 1:9], exp = Emat[1, 1:9])
map_mcmc <- gMAP(r ~ 1 + offset(log(exp)) | study, data = histdt, family = poisson,
                  tau.dist = "HalfNormal", tau.prior = cbind(0, 0.5),
                  beta.prior=cbind(0, 10))
```

The distribution of the MAP prior is unknown. Approximation is needed to convert it to a "workable" form. Since the the number of events follows the Poisson distribution, the MAP prior is approximated by a weighted mixture of Gamma distributions. The number of components may be determined automatically by the algorithm. 
```{r}
map_hat <- automixfit(map_mcmc)
print(map_hat)
```

The mixture has three Gamma components. The approximation can be examined either numerically or visually. 
```{r}
summary(map_mcmc)$theta.pred
summary(map_hat)
plot(map_hat)$mix
```

## Robust MAP Prior

The vague prior $f_V$ to construct rMAP is $Ga(m=0.3, n=1)$ and we form a 50-50 mixture of original MAP prior and the vague prior, that is, 
$$
f_{rMAP} = 0.5*\hat{f}_{MAP} + 0.5*f_V.
$$
```{r}
rmap <- robustify(map_hat, weight=0.5, mean=0.3, n=1)
print(rmap)
summary(rmap)
```